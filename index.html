<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PinSeeker | Stableford Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #0f172a;
            --surface: rgba(30, 41, 59, 0.85);
            --accent: #38bdf8;
            --success: #22c55e;
            --danger: #ef4444;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg);
            background-image: linear-gradient(rgba(15, 23, 42, 0.88), rgba(15, 23, 42, 0.88)), 
                              url('https://images.unsplash.com/photo-1596245084930-9759c836696d?auto=format&fit=crop&q=80&w=2000');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text); 
            padding: 0; margin: 0; font-size: 13px; 
        }

        .hidden { display: none !important; }

        .brand-header { 
            padding: 30px 15px; 
            text-align: center; 
            border-bottom: 1px solid var(--border); 
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .logo-icon {
            width: 44px; height: 44px;
            background: linear-gradient(135deg, var(--accent), #0ea5e9);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.3);
            margin-bottom: 8px; font-size: 22px;
        }

        .main-title { 
            font-family: 'Montserrat', sans-serif;
            font-size: 32px; font-weight: 800; margin: 0; 
            background: linear-gradient(to right, #fff, var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-transform: uppercase; letter-spacing: -1.5px;
        }

        .subtitle { font-size: 10px; text-transform: uppercase; letter-spacing: 3px; color: var(--accent); font-weight: 700; margin-bottom: 10px; }

        .controls { 
            background: var(--surface); padding: 15px; position: sticky; top: 0; z-index: 100; 
            border-bottom: 1px solid var(--border); backdrop-filter: blur(12px);
        }
        
        .input-group { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
        input { background: rgba(15, 23, 42, 0.7); color: #fff; border: 1px solid var(--border); border-radius: 6px; padding: 10px; font-size: 14px; outline: none; width: 100%; }
        
        .btn-search { background: var(--border); color: var(--accent); font-size: 18px; padding: 6px 12px; border-radius: 6px; cursor: pointer; border: 1px solid var(--accent); }

        .btn-row { display: flex; justify-content: space-between; gap: 8px; flex-wrap: wrap; }
        button { padding: 10px 14px; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-size: 11px; transition: 0.2s; }

        .btn-add { background: var(--success); color: #fff; }
        .btn-save { background: #f59e0b; color: #fff; }
        .btn-back { background: var(--surface); color: var(--accent); border: 1px solid var(--accent); margin-bottom: 15px; width: 100%; }
        .btn-email { background: var(--accent); color: #0f172a; }
        .btn-reset { background: transparent; border: 1px solid var(--danger); color: var(--danger); }

        /* API Results Modal-ish */
        #api-results { 
            background: #1e293b; border: 1px solid var(--accent); border-radius: 8px; 
            margin: 10px 0; max-height: 200px; overflow-y: auto; padding: 10px;
        }
        .course-item { 
            padding: 8px; border-bottom: 1px solid var(--border); display: flex; 
            justify-content: space-between; align-items: center; cursor: pointer; 
        }
        .course-item:hover { background: rgba(56, 189, 248, 0.1); }

        .table-container { padding: 10px; overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; background: var(--surface); border-radius: 12px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); }
        th { background: rgba(17, 24, 39, 0.95); color: var(--text-muted); padding: 12px 4px; font-size: 10px; text-transform: uppercase; }
        td { border-bottom: 1px solid var(--border); padding: 12px 2px; text-align: center; }

        .score-in { width: 80%; text-align: center; font-weight: 800; font-size: 18px; background: rgba(15, 23, 42, 0.6); color: #fff; border: 1px solid var(--border); border-radius: 6px; padding: 6px 0; }
        .pts-label { color: var(--accent); font-size: 10px; font-weight: bold; display: block; margin-top: 4px; }

        .sub-row { background: rgba(51, 65, 85, 0.7); font-weight: bold; }
        .total-row { background: var(--accent) !important; color: #0f172a !important; font-weight: 800; }
        
        .history-section { padding: 20px 15px; }
        .history-card { background: var(--surface); padding: 18px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid var(--accent); cursor: pointer; backdrop-filter: blur(8px); }
        .history-card h4 { margin: 0 0 10px 0; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); padding-bottom: 8px; font-family: 'Montserrat'; }
        
        .p-stat { font-size: 12px; color: var(--text-muted); }
        .p-name { color: var(--text); font-weight: bold; }
        .p-score { color: var(--accent); font-weight: 800; }
    </style>
</head>
<body>

<div id="main-view">
    <div class="brand-header">
        <div class="logo-icon">‚õ≥</div>
        <div class="main-title">PinSeeker</div>
        <div class="subtitle">Stableford Performance Tracker</div>
    </div>

    <div class="controls">
        <div class="input-group">
            <input type="text" id="cName" placeholder="Course Name or City (e.g. North Berwick)" oninput="updateHeader()">
            <button class="btn-search" onclick="searchCourses()" title="Lookup Course">üîç</button>
            <input type="date" id="cDate" oninput="updateHeader()">
        </div>
        
        <div id="api-results" class="hidden"></div>

        <div class="btn-row">
            <div>
                <button class="btn-add" onclick="addP()">+ Player</button>
                <button class="btn-save" onclick="saveToHistory()">üíæ Archive</button>
                <button class="btn-email" onclick="emailActive()">üìß Email</button>
            </div>
            <button class="btn-reset" onclick="wipe()">Clear</button>
        </div>
    </div>

    <div class="table-container"><div id="app"></div></div>

    <div class="history-section">
        <div id="history-log"></div>
    </div>
</div>

<div id="detail-view" class="hidden">
    <div class="brand-header">
        <button class="btn-back" onclick="closeDetail()">‚Üê Back to Dashboard</button>
        <div id="detail-title" class="main-title" style="font-size:22px;">Round Detail</div>
    </div>
    <div class="table-container">
        <button class="btn-email" id="email-detail-btn" style="width:100%; margin-bottom:15px;">üìß Email Full Scorecard</button>
        <div id="detail-app"></div>
    </div>
</div>

<script>
    var STORAGE_KEY = "PINSEEKER_V22";
    var API_KEY = "3MV722TTL7TNBWUTUUIFENW5UQ"; 
    
    var golfData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
        course: "", date: "", players: [],
        pars: [4,4,4,3,4,5,4,4,3, 4,4,4,3,4,5,3,4,4],
        si: [9,13,7,17,3,1,15,5,11, 10,14,2,16,6,18,8,4,12],
        history: []
    };

    async function searchCourses() {
        const query = document.getElementById('cName').value;
        const resultsDiv = document.getElementById('api-results');
        if(!query) return alert("Enter a city or course name first!");

        resultsDiv.innerHTML = "<p style='font-size:11px'>Searching...</p>";
        resultsDiv.classList.remove('hidden');

        try {
            // Attempting API call - Note: City search is the most reliable for this API
            const response = await fetch(`https://api.golfcourseapi.com/v1/courses?city=${encodeURIComponent(query)}&country=UK`, {
                headers: { "Authorization": `Key ${API_KEY}`, "Accept": "application/json" }
            });
            
            const data = await response.json();
            
            if(!data || data.length === 0) {
                resultsDiv.innerHTML = "<p style='font-size:11px'>No courses found. Try 'North Berwick'.</p>";
                return;
            }

            let html = "<p style='font-size:10px; color:var(--accent); margin-bottom:5px;'>Results (Click to select):</p>";
            data.forEach(course => {
                html += `<div class="course-item" onclick="selectCourse('${course.name.replace(/'/g, "\\'")}')">
                            <span>${course.name}</span>
                            <small style="color:var(--text-muted)">${course.holes} Holes</small>
                         </div>`;
            });
            resultsDiv.innerHTML = html;
        } catch (err) {
            resultsDiv.innerHTML = "<p style='font-size:11px; color:var(--danger)'>API Error. Check CORS or Key.</p>";
        }
    }

    function selectCourse(name) {
        document.getElementById('cName').value = name;
        golfData.course = name;
        document.getElementById('api-results').classList.add('hidden');
        saveAndRender();
    }

    function updateHeader() {
        golfData.course = document.getElementById('cName').value;
        golfData.date = document.getElementById('cDate').value;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(golfData));
    }

    function addP() {
        var n = prompt("Player Name:");
        if(!n) return;
        var h = prompt("Handicap:", "0");
        golfData.players.push({name: n, hcp: parseInt(h)||0, scores: new Array(18).fill(0)});
        saveAndRender();
    }

    function updateVal(type, hIdx, pIdx, val) {
        var num = parseInt(val) || 0;
        if(type === 'course') golfData.pars[hIdx] = num;
        if(type === 'si') golfData.si[hIdx] = num;
        if(type === 'score') golfData.players[pIdx].scores[hIdx] = num;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(golfData));
        
        golfData.players.forEach((p, pi) => {
            var el = document.getElementById('pts-'+pi+'-'+hIdx);
            if(el) el.innerText = calcPts(p, hIdx, p.scores[hIdx], golfData.pars, golfData.si) + "pts";
        });
        clearTimeout(window.renderTimer);
        window.renderTimer = setTimeout(render, 2000); 
    }

    function saveToHistory() {
        if(golfData.players.length === 0) return;
        if(!confirm("Archive this round?")) return;
        golfData.history.unshift({
            id: Date.now(),
            course: golfData.course || "No Name",
            date: golfData.date || new Date().toLocaleDateString(),
            players: JSON.parse(JSON.stringify(golfData.players)),
            pars: [...golfData.pars],
            si: [...golfData.si]
        });
        golfData.players = []; golfData.course = ""; golfData.date = "";
        saveAndRender();
    }

    function openDetail(id) {
        const round = golfData.history.find(h => h.id === id);
        if(!round) return;
        document.getElementById('main-view').classList.add('hidden');
        document.getElementById('detail-view').classList.remove('hidden');
        document.getElementById('detail-title').innerText = round.course;
        document.getElementById('email-detail-btn').onclick = () => emailFullRound(round);
        
        let html = "<table><tr><th>Hole</th><th>Par</th><th>SI</th>";
        round.players.forEach(p => html += `<th>${p.name}<br><small>(${p.hcp})</small></th>`);
        html += "</tr>";
        for(let h=0; h<18; h++) {
            if(h === 9) html += genStaticSum(round, "OUT", 0, 8);
            html += `<tr><td>${h+1}</td><td style='color:#fbbf24'>${round.pars[h]}</td><td style='color:#f87171'>${round.si[h]}</td>`;
            round.players.forEach(p => html += `<td><strong>${p.scores[h] || 0}</strong><span class='pts-label'>${calcPts(p, h, p.scores[h], round.pars, round.si)}pts</span></td>`);
            html += "</tr>";
        }
        html += genStaticSum(round, "IN", 9, 17) + genStaticSum(round, "TOTAL", 0, 17);
        document.getElementById('detail-app').innerHTML = html + "</table>";
        window.scrollTo(0,0);
    }

    function closeDetail() { document.getElementById('detail-view').classList.add('hidden'); document.getElementById('main-view').classList.remove('hidden'); }

    function calcPts(p, hIdx, score, pars, si) {
        if(!score || score <= 0) return 0;
        let allow = Math.floor(p.hcp/18) + ((p.hcp%18) >= si[hIdx] ? 1 : 0);
        return Math.max(0, (pars[hIdx] + 2) - (score - allow));
    }

    function genStaticSum(round, lbl, start, end) {
        let pSum = 0; for(let k=start; k<=end; k++) pSum += round.pars[k];
        let row = `<tr class='${lbl === "TOTAL" ? "total-row" : "sub-row"}'><td>${lbl}</td><td>${pSum}</td><td>-</td>`;
        round.players.forEach(p => {
            let g=0, pts=0;
            for(let j=start; j<=end; j++) { if(p.scores[j]>0) { g+=p.scores[j]; pts+=calcPts(p,j,p.scores[j], round.pars, round.si); } }
            row += `<td>G:${g} P:${pts}</td>`;
        });
        return row + "</tr>";
    }

    function render() {
        document.getElementById('cName').value = golfData.course;
        document.getElementById('cDate').value = golfData.date;
        let html = "";
        if(golfData.players.length > 0) {
            html = "<table><tr><th>Hole</th><th>Par</th><th>SI</th>";
            golfData.players.forEach(p => html += `<th>${p.name}</th>`);
            html += "</tr>";
            for(let h=0; h<18; h++) {
                if(h === 9) html += genSumRowActive("OUT", 0, 8);
                html += `<tr><td>${h+1}</td>
                    <td><input type='number' value='${golfData.pars[h]}' class='score-in' style='width:35px; font-size:12px; color:#fbbf24;' oninput='updateVal(\"course\",${h},0,this.value)'></td>
                    <td><input type='number' value='${golfData.si[h]}' class='score-in' style='width:35px; font-size:12px; color:#f87171;' oninput='updateVal(\"si\",${h},0,this.value)'></td>`;
                golfData.players.forEach((p, pi) => {
                    html += `<td><input type='number' class='score-in' value='${p.scores[h]||""}' oninput='updateVal(\"score\",${h},${pi},this.value)'><span id='pts-${pi}-${h}' class='pts-label'>${calcPts(p, h, p.scores[h], golfData.pars, golfData.si)}pts</span></td>`;
                });
                html += "</tr>";
            }
            html += genSumRowActive("IN", 9, 17) + genSumRowActive("TOTAL", 0, 17) + "</table>";
        }
        document.getElementById('app').innerHTML = html || "<div style='text-align:center; padding:60px; color:#94a3b8; font-weight:bold;'>Ready? Enter a city to find a course or add players.</div>";
        
        let hLog = "";
        golfData.history.forEach(h => {
            let pSummaries = h.players.map(p => {
                let g = p.scores.reduce((a,b) => a + (parseInt(b)||0), 0);
                let pts = p.scores.reduce((sum, s, i) => sum + calcPts(p, i, s, h.pars, h.si), 0);
                return `<div class="p-stat"><span class="p-name">${p.name}</span>: <span class="p-score">${g} - ${pts}pts</span></div>`;
            }).join("");

            hLog += `<div class="history-card" onclick="openDetail(${h.id})">
                <h4>${h.course} <span style="font-size:11px; color:var(--accent)">${h.date}</span></h4>
                <div class="player-summary">${pSummaries}</div>
                <span class="del-hist" onclick="event.stopPropagation(); deleteHistory(${h.id})">Delete Round</span>
            </div>`;
        });
        document.getElementById('history-log').innerHTML = hLog;
    }

    function genSumRowActive(lbl, s, e) {
        let pSum = 0; for(let k=s; k<=e; k++) pSum += golfData.pars[k];
        let row = `<tr class='${lbl === "TOTAL" ? "total-row" : "sub-row"}'><td>${lbl}</td><td>${pSum}</td><td>-</td>`;
        golfData.players.forEach(p => {
            let g=0, pts=0;
            for(let j=s; j<=e; j++) { if(p.scores[j]>0) { g+=p.scores[j]; pts+=calcPts(p,j,p.scores[j], golfData.pars, golfData.si); } }
            row += `<td>G:${g} P:${pts}</td>`;
        });
        return row + "</tr>";
    }

    function emailFullRound(round) {
        if(!round || round.players.length === 0) return;
        let b = `‚õ≥ PINSEEKER SCORECARD: ${round.course}\nüìÖ DATE: ${round.date}\n\n`;
        b += `HOLE | PAR | SI | ` + round.players.map(p => p.name.toUpperCase().substring(0,5)).join(" | ") + `\n`;
        for(let h=0; h<18; h++) {
            let line = `${(h+1).toString().padStart(2,' ')}   |  ${round.pars[h]}  | ${round.si[h].toString().padStart(2,' ')} | `;
            round.players.forEach(p => line += `${p.scores[h]||0}(${calcPts(p, h, p.scores[h], round.pars, round.si)}p) | `);
            b += line + `\n`;
        }
        window.location.href = `mailto:?subject=Scorecard: ${round.course}&body=${encodeURIComponent(b)}`;
    }

    function emailActive() {
        const active = { course: golfData.course || "Active Round", date: golfData.date || "Today", players: golfData.players, pars: golfData.pars, si: golfData.si };
        emailFullRound(active);
    }

    function deleteHistory(id) { if(confirm("Delete round?")) { golfData.history = golfData.history.filter(h => h.id !== id); saveAndRender(); } }
    function saveAndRender() { localStorage.setItem(STORAGE_KEY, JSON.stringify(golfData)); render(); }
    function wipe() { if(confirm("Clear current card?")) { golfData.players=[]; saveAndRender(); } }
    render();
</script>
</body>
</html>
