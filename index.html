<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Score and stroke tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg: #0f172a;
            --surface: #1e293b;
            --accent: #38bdf8;
            --success: #22c55e;
            --danger: #ef4444;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 0; margin: 0; font-size: 13px; }

        .brand-header { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 20px 15px; text-align: center; border-bottom: 1px solid var(--border); }
        .main-title { font-size: 24px; font-weight: 700; margin: 0; color: #fff; }

        .controls { background: var(--surface); padding: 15px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); }
        .input-group { display: flex; gap: 10px; margin-bottom: 12px; }
        
        input { background: #0f172a; color: #fff; border: 1px solid var(--border); border-radius: 6px; padding: 10px; font-size: 14px; outline: none; width: 100%; }

        .btn-row { display: flex; justify-content: space-between; gap: 8px; flex-wrap: wrap; }
        button { padding: 10px 14px; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; text-transform: uppercase; font-size: 11px; transition: all 0.2s; }

        .btn-add { background: var(--success); color: #fff; }
        .btn-save { background: #f59e0b; color: #fff; } /* Orange */
        .btn-email { background: var(--accent); color: #0f172a; }
        .btn-reset { background: transparent; border: 1px solid var(--danger); color: var(--danger); }

        .table-container { padding: 10px; overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; background: var(--surface); border-radius: 8px; overflow: hidden; }
        th { background: #111827; color: var(--text-muted); padding: 12px 4px; font-size: 10px; }
        td { border-bottom: 1px solid var(--border); padding: 10px 2px; text-align: center; }

        .score-in { width: 80%; text-align: center; font-weight: 800; font-size: 18px; background: #0f172a; color: #fff; border: 1px solid var(--border); border-radius: 4px; padding: 6px 0; }
        .pts-label { color: var(--accent); font-size: 10px; font-weight: bold; display: block; margin-top: 4px; }

        .sub-row { background: #334155; font-weight: bold; }
        .total-row { background: var(--accent) !important; color: #0f172a !important; font-weight: 800; }
        
        /* History Section */
        .history-section { padding: 20px 15px; background: #0f172a; }
        .history-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 5px;}
        .history-card { background: var(--surface); padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--accent); }
        .history-card h4 { margin: 0 0 5px 0; display: flex; justify-content: space-between; }
        .history-card p { margin: 2px 0; color: var(--text-muted); font-size: 12px; }
    </style>
</head>
<body>

<div class="brand-header">
    <div class="main-title">Score and stroke tracker</div>
</div>

<div class="controls">
    <div class="input-group">
        <input type="text" id="cName" placeholder="Course Name" oninput="updateHeader()">
        <input type="date" id="cDate" oninput="updateHeader()">
    </div>
    <div class="btn-row">
        <div>
            <button class="btn-add" onclick="addP()">+ Player</button>
            <button class="btn-save" onclick="saveToHistory()">ðŸ’¾ Finish & Archive</button>
            <button class="btn-email" onclick="emailOut()">Email</button>
        </div>
        <button class="btn-reset" onclick="wipe()">Clear Card</button>
    </div>
</div>

<div class="table-container">
    <div id="app"></div>
</div>

<div class="history-section">
    <div class="history-title">Round History</div>
    <div id="history-log"></div>
</div>

<script>
    var STORAGE_KEY = "SCORE_STROKE_TRACKER_V14";
    var golfData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
        course: "", date: "", players: [],
        pars: [4,4,4,3,4,5,4,4,3, 4,4,4,3,4,5,3,4,4],
        si: [9,13,7,17,3,1,15,5,11, 10,14,2,16,6,18,8,4,12],
        history: [] // New archive storage
    };

    function updateHeader() {
        golfData.course = document.getElementById('cName').value;
        golfData.date = document.getElementById('cDate').value;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(golfData));
    }

    function addP() {
        var n = prompt("Enter Player Name:");
        if(!n) return;
        var h = prompt("Enter Handicap:", "0");
        golfData.players.push({name: n, hcp: parseInt(h)||0, scores: new Array(18).fill(0)});
        saveAndRender();
    }

    function saveToHistory() {
        if(golfData.players.length === 0) return alert("Add players first.");
        if(!confirm("Finish round and move to history? This clears the current card.")) return;

        // Capture results
        let summary = golfData.players.map(p => {
            let pts = p.scores.reduce((sum, s, i) => sum + calcPts(golfData.players.indexOf(p), i, s), 0);
            return `${p.name}: ${pts}pts`;
        }).join(" | ");

        let roundRecord = {
            course: golfData.course || "Unknown Course",
            date: golfData.date || new Date().toLocaleDateString(),
            result: summary
        };

        golfData.history.unshift(roundRecord); // Add to start of history
        golfData.players = []; // Reset current card
        golfData.course = "";
        golfData.date = "";
        saveAndRender();
    }

    function updateVal(type, hIdx, pIdx, val) {
        var num = parseInt(val) || 0;
        if(type === 'course') golfData.pars[hIdx] = num;
        if(type === 'si') golfData.si[hIdx] = num;
        if(type === 'score') golfData.players[pIdx].scores[hIdx] = num;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(golfData));
        
        clearTimeout(window.renderTimer);
        window.renderTimer = setTimeout(render, 1500); 
    }

    function saveAndRender() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(golfData));
        render();
    }

    function wipe() { if(confirm("Clear current scorecard?")) { golfData.players=[]; saveAndRender(); } }

    function calcPts(pIdx, hIdx, score) {
        if(!score || score <= 0) return 0;
        var p = golfData.players[pIdx];
        var allow = Math.floor(p.hcp/18) + ((p.hcp%18) >= golfData.si[hIdx] ? 1 : 0);
        return Math.max(0, (golfData.pars[hIdx] + 2) - (score - allow));
    }

    function render() {
        document.getElementById('cName').value = golfData.course;
        document.getElementById('cDate').value = golfData.date;

        // Render Current Card
        if(golfData.players.length === 0) {
            document.getElementById('app').innerHTML = "<div style='text-align:center; padding:30px; color:var(--text-muted);'>No active round. Add players to start.</div>";
        } else {
            var html = "<table><tr><th>Hole</th><th>Par</th><th>SI</th>";
            golfData.players.forEach(p => { html += "<th>" + p.name + "</th>"; });
            html += "</tr>";
            for(var h=0; h<18; h++) {
                if(h === 9) html += genSumRow("OUT", 0, 8);
                html += "<tr><td>"+(h+1)+"</td>" +
                    "<td><input type='number' value='"+golfData.pars[h]+"' style='width:25px; border:none; background:none; text-align:center; color:#fbbf24;' oninput='updateVal(\"course\","+h+",0,this.value)'></td>" +
                    "<td><input type='number' value='"+golfData.si[h]+"' style='width:25px; border:none; background:none; text-align:center; color:#f87171;' oninput='updateVal(\"si\","+h+",0,this.value)'></td>";
                golfData.players.forEach((p, pi) => {
                    var s = p.scores[h] || "";
                    html += "<td><input type='number' class='score-in' value='"+s+"' oninput='updateVal(\"score\","+h+","+pi+",this.value)'><span class='pts-label'>"+calcPts(pi, h, s)+"pts</span></td>";
                });
                html += "</tr>";
            }
            html += genSumRow("IN", 9, 17);
            html += genSumRow("TOTAL", 0, 17);
            document.getElementById('app').innerHTML = html + "</table>";
        }

        // Render History
        var histHtml = "";
        golfData.history.forEach(h => {
            histHtml += `<div class="history-card">
                <h4>${h.course} <span>${h.date}</span></h4>
                <p>${h.result}</p>
            </div>`;
        });
        document.getElementById('history-log').innerHTML = histHtml || "<p style='color:#555'>No saved rounds yet.</p>";
    }

    function genSumRow(lbl, start, end) {
        var pSum = 0; for(var k=start; k<=end; k++) pSum += golfData.pars[k];
        var clss = (lbl === "TOTAL") ? "total-row" : "sub-row";
        var row = "<tr class='"+clss+"'><td>"+lbl+"</td><td>"+pSum+"</td><td>-</td>";
        golfData.players.forEach((p, pi) => {
            let g=0, pts=0;
            for(let j=start; j<=end; j++) { if(p.scores[j]>0) { g+=p.scores[j]; pts+=calcPts(pi,j,p.scores[j]); } }
            row += "<td>G:"+g+" | P:"+pts+"</td>";
        });
        return row + "</tr>";
    }

    function emailOut() {
        var b = "RESULTS\n" + golfData.course + " (" + golfData.date + ")\n\n";
        golfData.players.forEach((p, pi) => {
            let g = p.scores.reduce((a,b)=>a+b, 0);
            let pts = p.scores.reduce((sum, s, i) => sum + calcPts(pi, i, s), 0);
            b += p.name.toUpperCase() + ": Gross " + g + " | Points: " + pts + "\n";
        });
        window.location.href = "mailto:?subject=Scorecard&body=" + encodeURIComponent(b);
    }

    render();
</script>
</body>
</html>
